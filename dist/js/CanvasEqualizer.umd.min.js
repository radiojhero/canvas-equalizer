!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e(require("deep-assign")):"function"==typeof define&&define.amd?define(["deep-assign"],e):(t=t||self).CanvasEqualizer=e(t.deepAssign)}(this,(function(t){"use strict";function e(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function i(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}function n(t,e,n){return e&&i(t.prototype,e),n&&i(t,n),t}function s(t,e,i){return e in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}function a(t,e){if(t!==e)throw new TypeError("Cannot instantiate an arrow function")}function h(t,e){return function(t){if(Array.isArray(t))return t}(t)||function(t,e){if(!(Symbol.iterator in Object(t)||"[object Arguments]"===Object.prototype.toString.call(t)))return;var i=[],n=!0,s=!1,a=void 0;try{for(var h,r=t[Symbol.iterator]();!(n=(h=r.next()).done)&&(i.push(h.value),!e||i.length!==e);n=!0);}catch(t){s=!0,a=t}finally{try{n||null==r.return||r.return()}finally{if(s)throw a}}return i}(t,e)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}()}function r(t){return function(t){if(Array.isArray(t)){for(var e=0,i=new Array(t.length);e<t.length;e++)i[e]=t[e];return i}}(t)||function(t){if(Symbol.iterator in Object(t)||"[object Arguments]"===Object.prototype.toString.call(t))return Array.from(t)}(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance")}()}var o,u;function l(t,e,i,n){var s="__".concat(i,"_wrapper__");return t[s]||(t[s]=[]),c(t,i,n),t[s].push({elem:n,wrapper:e}),e}function c(t,e,i){var n,s=this,h="__".concat(e,"_wrapper__");return t[h]&&(t[h]=t[h].filter(function(t,e){return a(this,s),t.elem!==i||(n=t.wrapper,!1)}.bind(this))),n}if(t=t&&t.hasOwnProperty("default")?t.default:t,function(t){try{new CustomEvent("test")}catch(t){return}function e(e,i){i=i||{bubbles:!1,cancelable:!1};var n=document.createEvent("MouseEvent");return n.initMouseEvent(e,i.bubbles,i.cancelable,t,1,i.screenX,i.screenY,i.clientX,i.clientY,i.ctrlKey,i.altKey,i.shiftKey,i.metaKey,0,null),n}e.prototype=Event.prototype,t.MouseEvent=e}(window),window.PointerEvent)o=function(t,e,i,n){t.addEventListener("pointer".concat(e),i,n)},u=function(t,e,i,n){t.removeEventListener("pointer".concat(e),i,n)};else if("ontouchend"in document){var _={down:["start"],move:["move"],up:["end","cancel"]};o=function(t,e,i,n){var s=this,h=function(t){a(this,s);var n=t.changedTouches[0],h=new MouseEvent("mouse".concat(e),{altKey:t.altKey,clientX:n&&n.clientX||0,clientY:n&&n.clientY||0,ctrlKey:t.ctrlKey,metaKey:t.metaKey,screenX:n&&n.screenX||0,screenY:n&&n.screenY||0,shiftKey:t.shiftKey});h.clonedFromTouch=!0;var r=i(h);return(!1===r||h.defaultPrevented)&&m(t),r}.bind(this);_[e].forEach(function(r){a(this,s),t.addEventListener("touch".concat(r),l(i,h,"touch".concat(e),t),n)}.bind(this))},u=function(t,e,i,n){var s=this;_[e].forEach(function(h){a(this,s),t.removeEventListener("touch".concat(h),c(i,"touch".concat(e),t),n)}.bind(this))}}else o=function(t,e,i,n){t.addEventListener("mouse".concat(e),i,n)},u=function(t,e,i,n){t.removeEventListener("mouse".concat(e),i,n)};var d=[],v={Backspace:8,"\t":["Tab",9],"\n":["Enter",13],Escape:27,End:35,Home:36,ArrowLeft:37,ArrowUp:38,ArrowRight:39,ArrowDown:40,Delete:46};function f(t){for(var e=0;e<(arguments.length<=1?0:arguments.length-1);e++){var i=e+1<1||arguments.length<=e+1?void 0:arguments[e+1];if(-1!==Object.keys(v).indexOf(i)){var n=Array.isArray(v[i])?v[i]:[i,v[i]],s=h(n,2),a=s[0],r=s[1];if(t.key===a||t.keyCode===r)return!0}}return!1}function m(t){return t.preventDefault(),t.stopPropagation(),!1}function C(t,e){var i=this;if(-1===d.indexOf(t)){d.push(t);var n=function(){a(this,i),t(),d.splice(d.indexOf(t),1)}.bind(this);e?setTimeout(n,e):requestAnimationFrame(n)}}function p(t,e){var i=t.getBoundingClientRect();return{x:e.clientX-i.left,y:e.clientY-i.top}}function g(t,e,i){var n,s,a,h,r,o,u,l,c,_,d,v,f,m,C=e<<1,p=1;for(h=1;h<C;h+=2){for(p>h&&(_=t[p-1],t[p-1]=t[h-1],t[h-1]=_,_=t[p],t[p]=t[h],t[h]=_),s=e;s>=2&&p>s;)p-=s,s>>>=1;p+=s}for(h=1;h<=C;h+=4)_=t[(p=h+2)-1],d=t[p],t[p-1]=t[h-1]-_,t[p]=t[h]-d,t[h-1]+=_,t[h]+=d;for(n=4,c=i*Math.PI*.5;C>n;){for(a=n<<1,u=Math.sin(c),c*=.5,o=Math.sin(c),o*=-2*o,h=1;h<=C;h+=a)_=t[(p=h+n)-1],d=t[p],t[p-1]=t[h-1]-_,t[p]=t[h]-d,t[h-1]+=_,t[h]+=d;for(r=1+o,l=u,v=1+(n>>>1),s=3;s<v;s+=2){for(h=s;h<=C;h+=a)_=r*(f=t[(p=h+n)-1])-l*(m=t[p]),d=r*m+l*f,t[p-1]=t[h-1]-_,t[p]=t[h]-d,t[h-1]+=_,t[h]+=d;r+=(_=r)*o-l*u,l+=l*o+_*u}if(1===i){for(h=s;h<=C;h+=a)_=-t[p=h+n],d=t[p-1],t[p-1]=t[h-1]-_,t[p]=t[h]-d,t[h-1]+=_,t[h]+=d;r=-u,l=1+o}else{for(h=s;h<=C;h+=a)_=t[p=h+n],d=-t[p-1],t[p-1]=t[h-1]-_,t[p]=t[h]-d,t[h-1]+=_,t[h]+=d;r=u,l=-1-o}for(s+=2;s<n;s+=2){for(h=s;h<=C;h+=a)_=r*(f=t[(p=h+n)-1])-l*(m=t[p]),d=r*m+l*f,t[p-1]=t[h-1]-_,t[p]=t[h]-d,t[h-1]+=_,t[h]+=d;r+=(_=r)*o-l*u,l+=l*o+_*u}n=a}}function b(t,e,i){var n,s,a,h,r,o,u,l,c,_,d,v,f,m,C,p,b,y,w=e>>>2,M=Math.PI/(e>>>1);for(1===i?(_=-.5,g(t,e>>>1,1)):(_=.5,M=-M),b=Math.sin(.5*M),C=1+(b*=-2*b),p=y=Math.sin(M),n=1;n<w;n++)a=1+(s=n<<1),r=1+(h=e-s),d=.5*((o=t[s])+(l=t[h])),v=.5*((u=t[a])-(c=t[r])),f=-_*(u+c),m=_*(o-l),t[s]=d+(o=C*f)-(u=p*m),t[a]=v+(l=C*m)+(c=p*f),t[h]=d-o+u,t[r]=l+c-v,C+=(d=C)*b-p*y,p+=p*b+d*y;if(1===i)t[0]=(d=t[0])+t[1],t[1]=d-t[1];else for(t[0]=.5*((d=t[0])+t[1]),t[1]=.5*(d-t[1]),g(t,e>>>1,-1),d=2/e,n=e-1;n>=0;n--)t[n]*=d}var y={validYRangeHeight:255,visibleBinCount:512},w=function(){function i(n,h){var r=this,o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};e(this,i),s(this,"_options",void 0),s(this,"_visibleFrequencies",void 0),s(this,"_equivalentZones",void 0),s(this,"_equivalentZonesFrequencyCount",void 0),s(this,"_zeroChannelValueY",void 0),s(this,"_maximumChannelValue",void 0),s(this,"_minimumChannelValue",void 0),s(this,"_minusInfiniteChannelValue",void 0),s(this,"_maximumChannelValueY",void 0),s(this,"_minimumChannelValueY",void 0),s(this,"_filterLength",void 0),s(this,"_sampleRate",void 0),s(this,"_isNormalized",void 0),s(this,"_binCount",void 0),s(this,"_audioContext",void 0),s(this,"_filterKernel",void 0),s(this,"_convolver",void 0),s(this,"_tmp",void 0),s(this,"_channelCurves",void 0),s(this,"_actualChannelCurve",void 0),s(this,"_channelIndex",void 0),i._validateFilterLength(n),this._options=t({},y,o),this._filterLength=n,this._sampleRate=h.sampleRate||44100,this._isNormalized=!1,this._binCount=1+(n>>>1),this._audioContext=h,this._filterKernel=h.createBuffer(2,n,this._sampleRate),this._tmp=new Float32Array(n),this._channelCurves=[new Int16Array(this._options.visibleBinCount),new Int16Array(this._options.visibleBinCount)],this._actualChannelCurve=new Int16Array(this._options.visibleBinCount),this._channelIndex=-1,this._zeroChannelValueY=this._options.validYRangeHeight>>>1,this._maximumChannelValue=this._options.validYRangeHeight>>>1,this._minimumChannelValue=-(this._options.validYRangeHeight>>>1),this._minusInfiniteChannelValue=-(this._options.validYRangeHeight>>>1)-1,this._maximumChannelValueY=0,this._minimumChannelValueY=this._options.validYRangeHeight-1,this._visibleFrequencies=new Float32Array(this._options.visibleBinCount),this._equivalentZones=new Uint16Array([31,62,125,250,500,1e3,2e3,4e3,8e3,16e3]);var u=[0,9,18,36,71,107,177,249,321,393,512],l=this._options.visibleBinCount/u[u.length-1],c=[5,5,5,5,10,10,20,40,80,89],_=[5,50,95,185,360,720,1420,2860,5740,11498],d=_[0];this._options.visibleBinCount!==u[u.length-1]&&(u=u.map(function(t){return a(this,r),Math.round(t*l)}.bind(this)),c=c.map(function(t){return a(this,r),t/l}.bind(this))),this._equivalentZonesFrequencyCount=new Float32Array(u);for(var v=0,f=0;v<this._options.visibleBinCount;v++)this._visibleFrequencies[v]=d,f!==u.length-1&&f!==_.length-1&&v+1>=u[f+1]?d=_[++f]:d+=c[f];this.reset(),this._convolver=h.createConvolver(),this._convolver.normalize=!1,this._convolver.buffer=this._filterKernel}return n(i,[{key:"reset",value:function(){for(var t=this._options.visibleBinCount-1;t>=0;t--)this._channelCurves[0][t]=this._zeroChannelValueY,this._channelCurves[1][t]=this._zeroChannelValueY,this._actualChannelCurve[t]=this._zeroChannelValueY;this.updateFilter(!0),this.updateActualChannelCurve(0)}},{key:"clampY",value:function(t){var e=this._maximumChannelValueY,i=this._minimumChannelValueY;return t<=e?e:t>i?this._options.validYRangeHeight+1:t}},{key:"yToDB",value:function(t){var e=this._maximumChannelValueY,n=this._minimumChannelValueY;return t<=e?40:t>n?-1/0:i._lerp(e,40,n,-40,t)}},{key:"yToMagnitude",value:function(t){var e=this._maximumChannelValueY,n=this._minimumChannelValueY;return t<=e?100:t>n?0:Math.exp(i._lerp(e,2,n,-2,t)*Math.LN10)}},{key:"magnitudeToY",value:function(t){var e=this._zeroChannelValueY;return t>=100?this._maximumChannelValueY:t<.01?this._options.validYRangeHeight+1:Math.round(e-e*Math.log(t)/Math.LN10*.5-.4)}},{key:"visibleBinToZoneIndex",value:function(t){if(t>=this._options.visibleBinCount-1)return this._equivalentZones.length-1;if(t>0)for(var e=this._equivalentZonesFrequencyCount,i=e.length-1;i>=0;i--)if(t>=e[i])return i;return 0}},{key:"visibleBinToFrequency",value:function(t){var e=this._visibleFrequencies,i=this._options.visibleBinCount;return t>=i-1?e[i-1]:t>0?e[t]:e[0]}},{key:"visibleBinToFrequencyGroup",value:function(t){var e=this._equivalentZones,i=this._visibleFrequencies,n=this._options.visibleBinCount;if(t>=n-1)return[Math.round(i[n-1]),Math.round(e[e.length-1])];if(t>0)for(var s=this._equivalentZonesFrequencyCount,a=s.length-1;a>=0;a--)if(t>=s[a])return[Math.round(i[t]),Math.round(e[a])];return[Math.round(i[0]),Math.round(e[0])]}},{key:"changeZoneY",value:function(t,e,i){var n=this.visibleBinToZoneIndex(e),s=this._equivalentZonesFrequencyCount[n+1],a=this.clampY(i),h=this._channelCurves[t];for(n=this._equivalentZonesFrequencyCount[n];n<s;n++)h[n]=a}},{key:"_updateBuffer",value:function(){if(this._options.convolverCallback){var t=this._convolver;this._convolver=this.audioContext.createConvolver(),this._convolver.normalize=!1,this._convolver.buffer=this._filterKernel,this._options.convolverCallback(t,this._convolver)}else this._convolver.buffer=this._filterKernel}},{key:"copyFilter",value:function(t,e){for(var i=this._filterKernel.getChannelData(t),n=this._filterKernel.getChannelData(e),s=this._filterLength-1;s>=0;s--)n[s]=i[s];this._convolver&&this._updateBuffer()}},{key:"updateFilter",value:function(t){var e=Math.max(this._channelIndex,0),n=-1===e,s=this._filterLength,a=this._channelCurves[e],h=this._options.visibleBinCount,r=this._sampleRate/s,o=s>>>1,u=this._filterKernel.getChannelData(e),l=this._visibleFrequencies,c=.5*Math.PI,_=1,d=Number(this._isNormalized)+1;do{d--;for(var v=1,f=0;;){if(r*v>=l[0])break;var m=this.yToMagnitude(a[0]);u[v<<1]=m*_,v++}for(;r>l[f+1]-l[f]&&v<o&&f<h-1;){var C=r*v,p=0,g=0;do{p+=a[f],g++,f++}while(C>l[f]&&f<h-1);var y=this.yToMagnitude(p/g);u[v<<1]=y*_,v++}for(;v<o;v++){var w=r*v,M=void 0;if(w>=l[h-1])M=this.yToMagnitude(a[h-1]);else{for(;f<h-1&&w>l[f+1];)f++;M=this.yToMagnitude(i._lerp(l[f],a[f],l[f+1],a[f+1],w))}u[v<<1]=M*_}for(u[0]=u[2]>=1?1:u[2],u[1]=u[s-2]>=1?1:u[s-2],v=s-2;v>=2;v-=2){var k=c*(v>>>1);u[v+1]=u[v]*Math.sin(k),u[v]*=Math.cos(k)}b(u,s,-1),d&&((_=this._applyWindowAndComputeActualMagnitudes(u))<=0&&(d=0),_=1/_)}while(d);if(n)this.copyFilter(e,1-e);else{if(t){var x=this._channelIndex;return this._channelIndex=1-e,this.updateFilter(!1),void(this._channelIndex=x)}this._convolver&&this._updateBuffer()}}},{key:"updateActualChannelCurve",value:function(t){var e=this._filterLength,n=this._actualChannelCurve,s=this._options.visibleBinCount,a=this._sampleRate/e,h=e>>>1,r=this._tmp,o=this._visibleFrequencies,u=this._filterKernel.getChannelData(t);this._applyWindowAndComputeActualMagnitudes(u);for(var l=0,c=0;c<s-1&&l<h&&a>o[c+1]-o[c];){for(var _=a*l;l<h&&_+a<o[c];)_=a*++l;n[c]=this.magnitudeToY(i._lerp(_,r[l],_+a,r[l+1],o[c])),c++}for(l++;l<h&&c<s;){var d=void 0,v=0,f=0;do{v+=r[l],f++,d=a*++l}while(d<o[c]&&l<h);n[c]=this.magnitudeToY(v/f),c++}for(l=this._sampleRate>>>1>=o[s-1]?n[c-1]:this._options.validYRangeHeight+1;c<s;c++)n[c]=l}},{key:"_applyWindowAndComputeActualMagnitudes",value:function(t){for(var e=this._filterLength,i=this._tmp,n=e>>>1,s=n,a=2*Math.PI/s,h=s;h>=0;h--)i[h]=t[h]*(.42-.5*Math.cos(a*h)+.08*Math.cos(2*a*h));for(var r=e-1;r>s;r--)i[r]=0;b(i,e,1);for(var o=i[1],u=i[0]>o?i[0]:o,l=2;l<e;l+=2){var c=i[l],_=i[l+1],d=Math.sqrt(c*c+_*_);i[l>>>1]=d,d>u&&(u=d)}return i[n]=o,u}},{key:"filterLength",get:function(){return this._filterLength},set:function(t){this._filterLength!==t&&(i._validateFilterLength(t),this._filterLength=t,this._binCount=1+(t>>>1),this._filterKernel=this._audioContext.createBuffer(2,t,this._sampleRate),this._tmp=new Float32Array(t),this.updateFilter(!0))}},{key:"sampleRate",get:function(){return this._sampleRate},set:function(t){this.sampleRate!==t&&(this._sampleRate=t,this._filterKernel=this._audioContext.createBuffer(2,this._filterLength,t),this.updateFilter(!0))}},{key:"isNormalized",get:function(){return this._isNormalized},set:function(t){this.isNormalized!==t&&(this._isNormalized=t,this.updateFilter(!0))}},{key:"audioContext",get:function(){return this._audioContext},set:function(t){if(this.audioContext!==t){var e=this._convolver;this._convolver.disconnect(0),this._audioContext=t,this._filterKernel=t.createBuffer(2,this._filterLength,this._sampleRate),this._convolver=null,this.updateFilter(!0),this._convolver=t.createConvolver(),this._convolver.normalize=!1,this._convolver.buffer=this._filterKernel,this._options.convolverCallback&&this._options.convolverCallback(e,this._convolver)}}},{key:"options",get:function(){return t({},y,this._options)}},{key:"visibleFrequencies",get:function(){return this._visibleFrequencies}},{key:"channelCurves",get:function(){return this._channelCurves.slice()}},{key:"actualChannelCurve",get:function(){return this._actualChannelCurve}},{key:"convolver",get:function(){return this._convolver}},{key:"channelIndex",get:function(){return this._channelIndex},set:function(t){this._channelIndex=t}},{key:"zeroChannelValueY",get:function(){return this._zeroChannelValueY}},{key:"equivalentZonesFrequencyCount",get:function(){return this._equivalentZonesFrequencyCount}}],[{key:"_validateFilterLength",value:function(t){if(t<8||t&t-1)throw new Error("The FFT size must be power of 2 and not less than 8.")}},{key:"_lerp",value:function(t,e,i,n,s){return(s-t)*(n-e)/(i-t)+e}}]),i}(),M={"cursor.label":"Cursor: <span></span> dB","curve.label":"Curve: <span></span> dB","frequency.label":"Frequency: <span></span>","frequency.text":"{0} ({1})","frequency.format":"{0} {1}","frequency.unit.Hz":"Hz","frequency.unit.kHz":"kHz",menu:"Options","menu.both":"Same curve for both channels","menu.both.left":"Use left curve","menu.both.right":"Use right curve","menu.one":"One curve for each channel","menu.one.left":"Show left curve","menu.one.right":"Show right curve","menu.zones":"Show zones","menu.zoneEdit":"Edit by zones","menu.normalizeCurves":"Normalize curves","menu.actualResponse":"Show actual response"},k=function(){function t(){var i=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"en";e(this,t),s(this,"_language",void 0),s(this,"_locales",{}),this._language=i,this.loadLocale("en",M)}return n(t,[{key:"loadLocale",value:function(t,e){this._locales[t]=e}},{key:"get",value:function(t){var e=this._locales[this._language]||this._locales.en;return void 0===e[t]&&(e=this._locales.en),e[t]}},{key:"format",value:function(t){var e=this;t=this.get(t);for(var i=arguments.length,n=new Array(i>1?i-1:0),s=1;s<i;s++)n[s-1]=arguments[s];return n.forEach(function(i,n){a(this,e),t=t.replace(new RegExp("\\{".concat(n,"\\}"),"g"),i.toLocaleString(this._language))}.bind(this)),t}},{key:"language",get:function(){return this._language},set:function(t){this._language=t}}]),t}(),x={classNamespace:"GE",filterOptions:{},updateFilterOnDrag:!0};return function(){function i(n,h){var r=this,l=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};e(this,i),s(this,"_options",void 0),s(this,"_filter",void 0),s(this,"_element",void 0),s(this,"_canvas",void 0),s(this,"_ctx",void 0),s(this,"_rangeImage",void 0),s(this,"_btnMnu",void 0),s(this,"_mnu",void 0),s(this,"_mnuChBL",void 0),s(this,"_mnuChL",void 0),s(this,"_mnuChBR",void 0),s(this,"_mnuChR",void 0),s(this,"_mnuShowZones",void 0),s(this,"_mnuEditZones",void 0),s(this,"_mnuNormalizeCurves",void 0),s(this,"_mnuShowActual",void 0),s(this,"_lblCursor",void 0),s(this,"_lblCurve",void 0),s(this,"_lblFrequency",void 0),s(this,"_stb",void 0),s(this,"_showZones",!1),s(this,"_editZones",!1),s(this,"_isActualChannelCurveNeeded",!0),s(this,"_currentChannelIndex",0),s(this,"_isSameFilterLR",!0),s(this,"_drawingMode",0),s(this,"_lastDrawX",0),s(this,"_lastDrawY",0),s(this,"_barHideTimeout",void 0),s(this,"_l10n",void 0),s(this,"_isRTL",!1),s(this,"_formatFrequencyUnit",function(t,e){a(this,r);var i="Hz";return e&&t>=1e3&&(i="k"+i,t/=1e3),this._l10n.format("frequency.format",t,this._l10n.get("frequency.unit.".concat(i)))}.bind(this)),s(this,"_wrappedUpdateFilter",function(){a(this,r),this._filter.updateFilter(!1)}.bind(this)),s(this,"_btnMnuClick",function(t){a(this,r),t.button||this._toggleMenu()}.bind(this)),s(this,"_mnuChBLClick",function(t){a(this,r),this._mnuChBClick(t,0)}.bind(this)),s(this,"_mnuChBRClick",function(t){a(this,r),this._mnuChBClick(t,1)}.bind(this)),s(this,"_mnuChBClick",function(t,e){a(this,r),t.button||this._isSameFilterLR&&this._currentChannelIndex===e||(this._isSameFilterLR?(this._currentChannelIndex=e,this._filter.channelIndex=-1,this._filter.updateFilter(!0),this._isActualChannelCurveNeeded&&this._filter.updateActualChannelCurve(e),this._drawCurve()):(this._isSameFilterLR=!0,this._filter.copyFilter(e,1-e),this._currentChannelIndex!==e&&(this._currentChannelIndex=e,this._isActualChannelCurveNeeded&&this._filter.updateActualChannelCurve(e),this._drawCurve())),this._checkMenu(this._mnuChBL,0===e),this._checkMenu(this._mnuChBR,1===e))}.bind(this)),s(this,"_mnuChLClick",function(t){a(this,r),this._mnuChLRClick(t,0)}.bind(this)),s(this,"_mnuChRClick",function(t){a(this,r),this._mnuChLRClick(t,1)}.bind(this)),s(this,"_mnuChLRClick",function(t,e){a(this,r),t.button||(this._isSameFilterLR||this._currentChannelIndex!==e)&&(this._isSameFilterLR&&(this._isSameFilterLR=!1,this._filter.channelIndex=1-this._currentChannelIndex,this._filter.updateFilter(!1)),this._currentChannelIndex!==e&&(this._currentChannelIndex=e,this._isActualChannelCurveNeeded&&this._filter.updateActualChannelCurve(e),this._drawCurve()),this._checkMenu(this._mnuChL,0===e),this._checkMenu(this._mnuChR,1===e))}.bind(this)),s(this,"_mnuShowZonesClick",function(t){a(this,r),t.button||(this._showZones=!this._showZones,this._checkMenu(this._mnuShowZones,this._showZones),this._drawCurve())}.bind(this)),s(this,"_mnuEditZonesClick",function(t){a(this,r),t.button||(this._editZones=!this._editZones,this._canvas.classList[this._editZones?"add":"remove"]("".concat(this._options.classNamespace,"CNVZON")),this._checkMenu(this._mnuEditZones,this._editZones))}.bind(this)),s(this,"_mnuNormalizeCurvesClick",function(t){a(this,r),t.button||(this._filter.isNormalized=!this._filter.isNormalized,this._checkMenu(this._mnuNormalizeCurves,this._filter.isNormalized),this._isActualChannelCurveNeeded&&(this._filter.updateActualChannelCurve(this._currentChannelIndex),this._drawCurve()))}.bind(this)),s(this,"_mnuShowActualClick",function(t){a(this,r),t.button||(this._isActualChannelCurveNeeded=!this._isActualChannelCurveNeeded,this._checkMenu(this._mnuShowActual,this._isActualChannelCurveNeeded),this._isActualChannelCurveNeeded&&this._filter.updateActualChannelCurve(this._currentChannelIndex),this._drawCurve())}.bind(this)),s(this,"_btnMnuKeyDown",function(t){var e=this;a(this,r),f(t,"ArrowUp","ArrowDown")&&(m(t),this._toggleMenu(f(t,"ArrowUp")),window.setTimeout(function(){a(this,e);var t=this._mnu.querySelectorAll(".".concat(this._options.classNamespace,"MNUIT"));t[t.length-1].focus()}.bind(this)))}.bind(this)),s(this,"_mnuKeyDown",function(t){var e=this;a(this,r);var i=function(t,i){a(this,e);var n=i?"nextSibling":"previousSibling",s=t;do{if((s=s[n])instanceof HTMLButtonElement&&s.classList.contains("".concat(this._options.classNamespace,"MNUIT")))return s.focus(),!0}while(s);return!1}.bind(this);if(f(t,"ArrowUp","ArrowDown")){m(t);var n=f(t,"ArrowDown");!i(t.target,n)&&n&&this._btnMnu.focus()}}.bind(this)),s(this,"_canvasMouseDown",function(t){if(a(this,r),!t.button){if(!this._drawingMode){var e=p(this._canvas,t),i=e.x,n=e.y,s=Math.floor(i/this._widthRatio()),h=n/this._heightRatio();s>=0&&s<this._filter.options.visibleBinCount&&(this._drawingMode=1,this._editZones?this._filter.changeZoneY(this._currentChannelIndex,s,h):(this._filter.channelCurves[this._currentChannelIndex][s]=this._filter.clampY(h),this._lastDrawX=s,this._lastDrawY=h),this._drawCurve(),this._canvas.setPointerCapture?this._canvas.setPointerCapture(t.pointerId):t.clonedFromTouch||(u(this._canvas,"move",this._canvasMouseMove),u(this._canvas,"up",this._canvasMouseUp),o(document,"move",this._documentMouseMove,!0),o(document,"up",this._documentMouseUp,!0)))}return m(t)}return!0}.bind(this)),s(this,"_canvasMouseUp",function(t){a(this,r),this._drawingMode&&(this._drawingMode=0,this._filter.channelIndex=this._currentChannelIndex,this._filter.updateFilter(!1),this._isActualChannelCurveNeeded&&this._filter.updateActualChannelCurve(this._currentChannelIndex),this._drawCurve(),this._canvas.releasePointerCapture?this._canvas.releasePointerCapture(t.pointerId):t.clonedFromTouch||(u(document,"move",this._documentMouseMove,!0),u(document,"up",this._documentMouseUp,!0),o(this._canvas,"move",this._canvasMouseMove),o(this._canvas,"up",this._canvasMouseUp)))}.bind(this)),s(this,"_canvasMouseMove",function(t){a(this,r);var e=this._filter.channelCurves[this._currentChannelIndex],i=p(this._canvas,t),n=i.x,s=i.y;if(this._drawingMode||n>=0&&n<this._canvas.width&&s>=0&&s<this._canvas.height){var h=Math.floor(n/this._widthRatio()),o=s/this._heightRatio();if(h<0?h=0:h>=this._filter.options.visibleBinCount&&(h=this._filter.options.visibleBinCount-1),this._drawingMode){if(this._editZones)this._filter.changeZoneY(this._currentChannelIndex,h,o);else{if(Math.abs(h-this._lastDrawX)>1){var u=(o-this._lastDrawY)/Math.abs(h-this._lastDrawX),l=h<this._lastDrawX?-1:1;o=this._lastDrawY+u;var c=Math.abs(h-this._lastDrawX)-1;for(h=this._lastDrawX+l;c>0;h+=l,c--)e[h]=this._filter.clampY(o),o+=u}e[h]=this._filter.clampY(o),this._lastDrawX=h,this._lastDrawY=o}this._drawCurve(),this._options.updateFilterOnDrag&&C(this._wrappedUpdateFilter,150)}else this._isActualChannelCurveNeeded&&(e=this._filter.actualChannelCurve);if(this._setStatusBar(h,o,e[h]),this._drawingMode)return m(t)}return!0}.bind(this)),s(this,"_windowResize",function(){a(this,r),this._fixCanvasSize()}.bind(this)),s(this,"_documentMouseMove",function(t){return a(this,r),this._canvasMouseMove(t)}.bind(this)),s(this,"_documentMouseUp",function(t){a(this,r),this._canvasMouseUp(t)}.bind(this)),this._options=t({},x,l),this._filter=new w(n,h,this._options.filterOptions),this._l10n=new k(this._options.language)}return n(i,[{key:"createControl",value:function(t){var e=this;if(!this._ctx){var i=function(t,i){a(this,e);var n=document.createElement("div");return n.className="".concat(r,"LBL ").concat(r,"LBL").concat(t),n.innerHTML=this._l10n.get(i),n}.bind(this),n=function(){a(this,e);var t=document.createElement("div");return t.className="".concat(r,"MNUSEP"),t.setAttribute("role","separator"),t}.bind(this),s=function(t){a(this,e);var i=document.createElement("div");return i.className="".concat(r,"MNULBL"),i.textContent=this._l10n.get(t),i}.bind(this),h=function(t,i,n,s){var h=this;a(this,e);var o=document.createElement("button");if(o.type="button",o.className="".concat(r,"MNUIT ").concat(r,"CLK"),i){"string"==typeof i?(o.dataset.radioGroup=i,o.setAttribute("role","menuitemradio")):o.setAttribute("role","menuitemcheckbox");var u=document.createElement("span");u.textContent="string"==typeof i?"● ":"■ ",o.appendChild(u),this._checkMenu(o,n)}else o.setAttribute("role","menuitem");return o.appendChild(document.createTextNode(this._l10n.get(t))),s&&o.addEventListener("click",s),o.addEventListener("mouseenter",function(){a(this,h),o.focus()}.bind(this)),o.addEventListener("mouseleave",function(){a(this,h),o.blur()}.bind(this)),o}.bind(this),r=this._options.classNamespace;this._element=t,t.className=r,/\bip(?:[ao]d|hone)\b/i.test(navigator.userAgent)&&!window.MSStream&&t.classList.add("".concat(r,"IOS")),"rtl"===getComputedStyle(t).direction&&(t.classList.add("RTL"),this._isRTL=!0),t.addEventListener("contextmenu",m),this._stb=document.createElement("div"),this._stb.className="".concat(r,"STB"),t.appendChild(this._stb),this._canvas=document.createElement("canvas"),this._canvas.className="".concat(r,"CNV"),o(this._canvas,"down",this._canvasMouseDown),o(this._canvas,"move",this._canvasMouseMove),o(this._canvas,"up",this._canvasMouseUp),this._canvas.addEventListener("contextmenu",m),t.appendChild(this._canvas),function(t,e,i,n){var s=this,h=!1,r=function(t){var e=this;a(this,s),h||(h=!0,requestAnimationFrame(function(){a(this,e),i(t),h=!1}.bind(this)))}.bind(this);t.addEventListener(e,l(i,r,"throttle".concat(e),t),n)}(window,"resize",this._windowResize);var u=this._canvas.getContext("2d");if(!u)throw new Error("Unable to get a 2D context.");this._ctx=u,this._stb.appendChild(this._lblCursor=i("CSR","cursor.label")),this._stb.appendChild(this._lblCurve=i("CRV","curve.label")),this._stb.appendChild(this._lblFrequency=i("FRQ","frequency.label")),this._setStatusBar(0,this._filter.zeroChannelValueY,this._filter.zeroChannelValueY),this._btnMnu=document.createElement("button"),this._btnMnu.type="button",this._btnMnu.className="".concat(r,"BTN ").concat(r,"CLK"),this._btnMnu.setAttribute("aria-haspopup","true"),this._btnMnu.setAttribute("aria-label",this._l10n.get("menu")),this._btnMnu.addEventListener("click",this._btnMnuClick),this._btnMnu.addEventListener("keydown",this._btnMnuKeyDown),this._btnMnu.addEventListener("mouseenter",function(){a(this,e),this._btnMnu.focus()}.bind(this)),this._btnMnu.addEventListener("mouseleave",function(){a(this,e),this._btnMnu.blur()}.bind(this)),this._stb.appendChild(this._btnMnu),this._mnu=document.createElement("div"),this._mnu.className="".concat(r,"MNU"),this._mnu.setAttribute("role","menu"),this._mnu.addEventListener("keydown",this._mnuKeyDown),this._mnu.appendChild(s("menu.both")),this._mnu.appendChild(this._mnuChBL=h("menu.both.left","curve",!0,this._mnuChBLClick)),this._mnu.appendChild(this._mnuChBR=h("menu.both.right","curve",!1,this._mnuChBRClick)),this._mnu.appendChild(n()),this._mnu.appendChild(s("menu.one")),this._mnu.appendChild(this._mnuChL=h("menu.one.left","curve",!1,this._mnuChLClick)),this._mnu.appendChild(this._mnuChR=h("menu.one.right","curve",!1,this._mnuChRClick)),this._mnu.appendChild(n()),this._mnu.appendChild(this._mnuShowZones=h("menu.zones",!0,!1,this._mnuShowZonesClick)),this._mnu.appendChild(this._mnuEditZones=h("menu.zoneEdit",!0,!1,this._mnuEditZonesClick)),this._mnu.appendChild(n()),this._mnu.appendChild(this._mnuNormalizeCurves=h("menu.normalizeCurves",!0,!1,this._mnuNormalizeCurvesClick)),this._mnu.appendChild(this._mnuShowActual=h("menu.actualResponse",!0,!0,this._mnuShowActualClick)),this._stb.appendChild(this._mnu),this._toggleMenu(!1),this._fixCanvasSize(),this._drawCurve()}return this._canvas}},{key:"destroyControl",value:function(){var t,e,i,n;this._ctx&&(t=window,e="resize",i=this._windowResize,t.removeEventListener(e,c(i,"throttle".concat(e),t),n),delete this._canvas,delete this._lblCursor,delete this._lblCurve,delete this._lblFrequency,delete this._btnMnu,delete this._mnu,delete this._mnuChBL,delete this._mnuChL,delete this._mnuChBR,delete this._mnuChR,delete this._mnuShowZones,delete this._mnuEditZones,delete this._mnuNormalizeCurves,delete this._mnuShowActual,delete this._stb,delete this._ctx,delete this._rangeImage,this._element.innerHTML="",delete this._element,clearTimeout(this._barHideTimeout))}},{key:"reset",value:function(){this._filter.reset(),this._drawCurve()}},{key:"loadLocale",value:function(t,e){this._l10n.loadLocale(t,e)}},{key:"_formatDB",value:function(t){t<-40&&(t=-1/0);var e=t.toLocaleString(this._l10n.language,{minimumFractionDigits:2,maximumFractionDigits:2});return t<0?e.replace("-","−"):0===t?"−"+e:"+"+e}},{key:"_formatFrequency",value:function(t){var e,i=this;return(e=this._l10n).format.apply(e,["frequency.text"].concat(r(t.map(function(t,e){return a(this,i),this._formatFrequencyUnit(t,!!e)}.bind(this)))))}},{key:"_checkMenu",value:function(t,e){var i=this;function n(t,e){t&&(t.style.visibility=e?"visible":"hidden",t.setAttribute("aria-checked",e.toString()))}e&&t.dataset.radioGroup&&[].slice.call(this._mnu.querySelectorAll('[data-radio-group="'.concat(t.dataset.radioGroup,'"]'))).forEach(function(t){a(this,i),n(t.firstChild,!1)}.bind(this)),n(t.firstChild,e)}},{key:"_drawCurve",value:function(){function t(t){return Math.round(t)+u}var e=this._ctx,i=this._canvas,n=window.devicePixelRatio,s=i.width/n,a=i.height/n,h=this._widthRatio(),r=this._heightRatio(),o=this._filter.options.visibleBinCount-1,u=.5,l=this._filter.channelCurves[this._currentChannelIndex];if(!e)return!1;e.fillStyle="#303030",e.fillRect(0,0,s,a),e.lineWidth=1,e.strokeStyle="#5a5a5a",e.beginPath();var c=s+1+u,_=t(this._filter.zeroChannelValueY*r);for(e.moveTo(c,_);c>0;)e.lineTo(c-4,_),c-=10,e.moveTo(c,_);for(e.stroke(),e.font="bold 10pt Verdana",e.textAlign=this._isRTL?"left":"right",e.fillStyle="#5a5a5a",e.fillText("‎−0dB",this._isRTL?1:s-1,Math.round(this._filter.zeroChannelValueY*r)-2),e.beginPath(),c=s-1-u,_=t(this._filter.options.validYRangeHeight*r),e.moveTo(c,_);c>0;)e.lineTo(c-4,_),c-=10,e.moveTo(c,_);if(e.stroke(),e.fillText("‎−∞dB",this._isRTL?1:s-1,Math.round(this._filter.options.validYRangeHeight*r)-2),this._showZones)for(var d=this._filter.equivalentZonesFrequencyCount.length-2;d>0;d--){for(c=t(this._filter.equivalentZonesFrequencyCount[d]*h),_=0,e.beginPath(),e.moveTo(c,_);_<a;)e.lineTo(c,_+4),_+=10,e.moveTo(c,_);e.stroke()}for(e.strokeStyle=this._isActualChannelCurveNeeded&&!this._drawingMode?"#707070":this._rangeImage,e.beginPath(),e.moveTo(.5,t(l[0]*r)),c=1;c<o;c++)e.lineTo(t(c*h),t(l[c]*r));if(e.lineTo(Math.round(c*h)+1,t(l[c]*r)),e.stroke(),this._isActualChannelCurveNeeded&&!this._drawingMode){for(l=this._filter.actualChannelCurve,e.strokeStyle=this._rangeImage,e.beginPath(),e.moveTo(u,t(l[0]*r)),c=1;c<o;c++)e.lineTo(t(c*h),t(l[c]*r));e.lineTo(Math.round(c*h)+1,t(l[c]*r)),e.stroke()}return!0}},{key:"_widthRatio",value:function(){return this._canvas.width/window.devicePixelRatio/this._filter.options.visibleBinCount}},{key:"_heightRatio",value:function(){var t=this._stb.clientHeight;return(this._canvas.height/window.devicePixelRatio-t-5)/this._filter.options.validYRangeHeight}},{key:"_fixCanvasSize",value:function(){this._canvas.style.display="none";var t=this._element.getBoundingClientRect(),e=window.devicePixelRatio;this._canvas.style.display="",this._canvas.style.width=t.width+"px",this._canvas.style.height=t.height+"px",this._canvas.width=t.width*e,this._canvas.height=t.height*e,this._ctx.setTransform(e,0,0,e,0,0),this._rangeImage=this._ctx.createLinearGradient(0,0,0,t.height-this._stb.clientHeight-5),this._rangeImage.addColorStop(0,"#ff0000"),this._rangeImage.addColorStop(.1875,"#ffff00"),this._rangeImage.addColorStop(.39453125,"#00ff00"),this._rangeImage.addColorStop(.60546875,"#00ffff"),this._rangeImage.addColorStop(.796875,"#0000ff"),this._rangeImage.addColorStop(1,"#ff00ff"),this._drawCurve()}},{key:"_setLabelParam",value:function(t,e){var i=t.querySelector("span");i&&(i.textContent=e)}},{key:"_setStatusBar",value:function(t,e,i){this._setLabelParam(this._lblCursor,this._formatDB(this._filter.yToDB(e))),this._setLabelParam(this._lblCurve,this._formatDB(this._filter.yToDB(i))),this._setLabelParam(this._lblFrequency,this._formatFrequency(this._filter.visibleBinToFrequencyGroup(t)))}},{key:"_toggleMenu",value:function(t){t=void 0===t?"none"===this._mnu.style.display:t,this._mnu.style.display=t?"":"none",this._btnMnu.textContent=t?"▼":"▲"}},{key:"options",get:function(){return t({},x,this._options)}},{key:"filterLength",get:function(){return this._filter.filterLength},set:function(t){this._filter.filterLength!==t&&(this._filter.filterLength=t,this._isActualChannelCurveNeeded&&this._filter.updateActualChannelCurve(this._currentChannelIndex),this._drawCurve())}},{key:"sampleRate",get:function(){return this._filter.sampleRate},set:function(t){this._filter.sampleRate!==t&&(this._filter.sampleRate=t,this._isActualChannelCurveNeeded&&this._filter.updateActualChannelCurve(this._currentChannelIndex),this._drawCurve())}},{key:"audioContext",get:function(){return this._filter.audioContext},set:function(t){this._filter.audioContext!==t&&(this._filter.audioContext=t)}},{key:"language",get:function(){return this._l10n.language},set:function(t){this._l10n.language=t}},{key:"visibleFrequencies",get:function(){return this._filter.visibleFrequencies}},{key:"convolver",get:function(){return this._filter.convolver}}]),i}()}));
//# sourceMappingURL=CanvasEqualizer.umd.min.js.map
